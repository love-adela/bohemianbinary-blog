{% extends "base.html" %}

{% block content %}
<p><a href="{{ url_for('add_movie') }}">새 영화 등록하기</a></p>
<ul class="list">

</ul>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    function show_movie_edit(id, name_en, name_kr){
        let body = "<input id='name-en-" + id + "' type='text' value='" + name_en + "'/>";
        body += "<input id='name-kr-" + id + "'type='text' value='" + name_kr + "'/>";
        body += "<button onclick='update_movie(" + id +")'>수정 완료</button>"
        $("#list-" + id).html(body);
    }

    function update_movie(id){
        name_en = $("#name-en-" + id).val();
        name_kr = $("#name-kr-" + id).val();
        isConfirmed = confirm(name_en + " 영화 항목을 수정하시겠습니까?");
        if (isConfirmed == true) {
            $.ajax({
                type: 'POST',
                url: '/anl-api/movie/' + id,
                data: JSON.stringify({
                    'id': id,
                    'name_en': name_en,
                    'name_kr': name_kr
                }),
                success: function(response) {
                    alert("수정에 성공했습니다.");
                    update_movies_html(response.movies);
                },
                contentType: 'application/json',
                dataType: 'json'
            })
        }
    }

    function update_photo(id, name_en){
        isConfirmed = confirm(name_en + " 사진을 수정하시겠습니까?");
        if (isConfirmed == true) {
            $.ajax({
                type: "PUT",
                url: '/anl-api/movie/' + id,
                success: function (response) {
                    alert("항목 수정에 성공했습니다.");
                    update_movies_html(response.movies);
                },
                contentType: 'application/json',
                dataType: 'json'
            })
        }
    }

    function delete_photo(id, name_en) {
        isConfirmed = confirm(name_en + " 사진을 삭제하시겠습니까?");
        if (isConfirmed == true) {
            $.ajax({
                type: "POST",
                url: '/anl-api/movie/photo',
                data: JSON.stringify({
                    'id': id
                }),
                success: function (response) {
                    alert("사진 삭제에 성공했습니다.");
                    update_movies_html(response.movies);
                },
                contentType: "application/json",
                dataType: 'json'
            })
        }
    }

    function delete_movie(id, name_en) {
        isConfirmed = confirm(name_en + " 항목을 삭제하시겠습니까?");
        if (isConfirmed == true) {
            $.ajax({
                type: "DELETE",
                url: '/anl-api/movie/' + id,
                success: function (response) {
                    alert("항목 삭제에 성공했습니다.");
                    update_movies_html(response.movies);
                },
                contentType: "application/json",
                dataType: 'json'
            })
        }
    }

    function update_movies_html(movies){
        html = "";
        for (var i in movies) {
            movie = movies[i];
            li = "<li id=\"list-" + movie.id + "\">";
            li += movie.name_en + " " + movie.name_kr;
            if (movie.photo != null) {
                li += "<img src='/static/" + movie.photo + "' />"
            }

            li += "<button onclick=\"show_movie_edit(" +
                movie.id + ", '" + movie.name_en + "', '" + movie.name_kr +  "')\">항목 수정</button>";
            li += "<button onclick=\"delete_photo(" + movie.id + ", '" + movie.name_en + "')\">사진 삭제</button>"
            li += "<button onclick=\"delete_movie(" + movie.id + ", '" + movie.name_en + "')\">항목 삭제</button>"
            li += "</li>";
            html += li;
        }
        $('.list').html(html);
    }


    $.getJSON('/anl-api/movie')
        .done(function (response) {
            update_movies_html(response.movies);
        }).fail(function (response) {
        console.log(response.text);
    })
</script>
{% endblock %}